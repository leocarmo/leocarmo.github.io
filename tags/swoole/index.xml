<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>swoole on leocarmo.dev</title><link>/tags/swoole/</link><description>Recent content in swoole on leocarmo.dev</description><generator>Hugo -- gohugo.io</generator><language>en</language><copyright>leocarmo.dev</copyright><lastBuildDate>Thu, 15 Jul 2021 19:30:00 -0300</lastBuildDate><atom:link href="/tags/swoole/index.xml" rel="self" type="application/rss+xml"/><item><title>Hyperf - PHP Coroutine Framework baseado em Swoole</title><link>/hyperf-php-coroutine-framework-baseado-em-swoole/</link><pubDate>Thu, 15 Jul 2021 19:30:00 -0300</pubDate><guid>/hyperf-php-coroutine-framework-baseado-em-swoole/</guid><description>Durante muito tempo que estudei sobre Swoole, eu sempre fazia as coisas &amp;ldquo;do zero&amp;rdquo; para tentar entender a fundo sobre ele. Cheguei a pesquisar alguns frameworks baseados nele, mas n√£o encontrei nenhum que tenha me chamado a aten√ß√£o. Ent√£o acabei seguindo meus estudos por conta mesmo, at√© agora.
Quando conheci o Hyperf n√£o imaginei o quanto ele era incr√≠vel at√© come√ßar a descobrir tudo que ele poderia me entregar. Praticamente todos os desafios que eu estava tendo para implementar do zero com Swoole, ele resolveu.</description><content>&lt;p>Durante muito tempo que estudei sobre &lt;a href="https://www.swoole.co.uk/">Swoole&lt;/a>, eu sempre fazia as coisas &amp;ldquo;do zero&amp;rdquo; para tentar entender a fundo sobre ele. Cheguei a pesquisar alguns frameworks baseados nele, mas n√£o encontrei nenhum que tenha me chamado a aten√ß√£o. Ent√£o acabei seguindo meus estudos por conta mesmo, at√© agora.&lt;/p>
&lt;p>Quando conheci o &lt;a href="https://github.com/hyperf/hyperf">Hyperf&lt;/a> n√£o imaginei o quanto ele era incr√≠vel at√© come√ßar a descobrir tudo que ele poderia me entregar. Praticamente todos os desafios que eu estava tendo para implementar do zero com Swoole, ele resolveu.&lt;/p>
&lt;p>Pode at√© parecer √≥timo ter tudo pronto, mas do que adianta ter um carro de f√≥rmula 1 se voc√™ n√£o souber dirigir? Ent√£o n√£o √© t√£o simples assim. √â preciso ter uma base de Swoole, programa√ß√£o concorrente, aplica√ß√£o stateful, etc., para conseguir extrair todo o poder que ele pode te dar.&lt;/p>
&lt;p>A ideia aqui √© te ajudar com os primeiros passos e ter um projeto m√≠nimo rodando, pois, s√≥ de utilizar o Hyperf como framework, voc√™ j√° conseguir√° sentir uma diferen√ßa absurda em performance.&lt;/p>
&lt;p>A documenta√ß√£o √© bacana, aborda bastante coisa e tem v√°rios exemplos, ent√£o vou passar por alguns t√≥picos e ir referenciando tudo aqui. Alguns conte√∫dos da documenta√ß√£o ainda est√£o em chin√™s, mas est√£o sendo traduzidos, enquanto isso, √© s√≥ traduzir que da tudo certo!&lt;/p>
&lt;p>Minha miss√£o aqui √©:&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Te incentivar a construir as suas pr√≥ximas aplica√ß√µes utilizando Hyperf e Swoole.&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>Ent√£o, bora l√°!&lt;/p>
&lt;p>T√≥picos:&lt;/p>
&lt;ol>
&lt;li>&lt;a href="#1-o-que-e">O que √©?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#2-instalacao">Instala√ß√£o&lt;/a>&lt;/li>
&lt;li>&lt;a href="#3-hot-reload">Hot Reload&lt;/a>&lt;/li>
&lt;li>&lt;a href="#4-estrutura">Estrutura&lt;/a>&lt;/li>
&lt;li>&lt;a href="#5-melhorando-o-ambiente">Melhorando o ambiente&lt;/a>&lt;/li>
&lt;li>&lt;a href="#6-database">Database&lt;/a>&lt;/li>
&lt;li>&lt;a href="#7-rotas-e-controllers">Rotas e Controllers&lt;/a>&lt;/li>
&lt;li>&lt;a href="#8-parallel">Parallel&lt;/a>&lt;/li>
&lt;li>&lt;a href="#9-benchmark">Benchmark&lt;/a>&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h2 id="1-o-que-√©">1. O que √©?&lt;/h2>
&lt;p>O Hyperf √© um framework de alto desempenho e altamente flex√≠vel baseado em Swoole 4.5+ com &lt;code>PHP CLI&lt;/code>. Ele possui um servidor de corrotina integrado com diversos componentes comumente usados.&lt;/p>
&lt;p>Durante cerca de meio ano, o Hyperf foi testado em diversas companhias pelo mundo, ap√≥s √≥timos resultados, ele foi liberado para a comunidade em 20/06/2019.&lt;/p>
&lt;blockquote>
&lt;p>Os dois trechos acima foram retirados e traduzidos da &lt;a href="https://hyperf.wiki/2.1/#/en/README">documenta√ß√£o oficial&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>Caso voc√™ n√£o conhe√ßa o Swoole PHP, recomendo dar uma olhada antes, pois vou assumir que voc√™ j√° conhece a forma com que ele funciona, j√° que o Hyperf √© baseado nele.&lt;/p>
&lt;blockquote>
&lt;p>Algumas recomenda√ß√µes de leitura para que voc√™ conhe√ßa e aprenda mais sobre Swoole:&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>&lt;a href="https://www.swoole.co.uk/docs/">O que √© Swoole&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.swoole.co.uk/how-it-works">Como Swoole funciona&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.linkedin.com/pulse/websocket-em-php-sim-%C3%A9-poss%C3%ADvel-ronie-neubauer/">Websocket em PHP com Swoole&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.amazon.com.br/Mastering-Swoole-PHP-performance-concurrent-ebook/dp/B0881B227S">Livro Mastering Swoole PHP&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://diegoborgs.com.br/blog/mastering-swoole-php-parte-i-introdu%C3%A7%C3%A3o">S√©rie de resumo do Livro&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>Uma coisa bem interessante, √© que o Hyperf √© muito similar ao &lt;a href="https://laravel.com/">Laravel&lt;/a>, ent√£o se voc√™ j√° trabalhou com Laravel, vai se adaptar muito bem ao Hyperf.&lt;/p>
&lt;p>Por ser baseado em Swoole, ele roda em cima do &lt;code>PHP CLI&lt;/code>, sendo stateful, e √© extremamente perform√°tico comparado ao &amp;ldquo;PHP tradicional&amp;rdquo;, utilizado via &lt;code>php-fpm&lt;/code>, e tamb√©m comparado a outras linguagens. üëÄ&lt;/p>
&lt;p>A proposta do Hyperf foi trazer todas as features do Swoole de forma simples para a comunidade, fazendo com que n√£o fosse preciso implementar tudo do zero. Grandes exemplos s√£o as pools de conex√µes, servidor HTTP, TCP, gRPC, &lt;a href="https://hyperf.wiki/2.1/#/en/README">entre outros&lt;/a>.&lt;/p>
&lt;p>Para exemplificar como funciona, ao utilizar o client pronto de Redis do Hyperf, voc√™ j√° tem uma pool criada por baixo com o client de Redis do Swoole, o que j√° ajuda muito na hora de fazer um projeto. A mesma coisa para o Eloquent ORM, ao utiliza-lo no Hyperf, por baixo j√° est√° tudo resolvido.&lt;/p>
&lt;blockquote>
&lt;p>Ou seja, n√£o tem motivos para n√£o achar isso incr√≠vel &amp;lt;3&lt;/p>
&lt;/blockquote>
&lt;p>Para entender o &lt;a href="https://hyperf.wiki/2.1/#/en/lifecycle">Lifecycle do Hyperf&lt;/a>, √© muito importante entender o &lt;a href="https://www.swoole.co.uk/docs/modules/swoole-http-server-doc">Lifecycle do Swoole&lt;/a>. Como o Swoole √© executado via &lt;code>PHP CLI&lt;/code>, o Hyperf se inicia tamb√©m via &lt;code>PHP CLI&lt;/code>, utilizando o &lt;a href="https://github.com/symfony/console">symfony/console&lt;/a> como &lt;code>command&lt;/code>.&lt;/p>
&lt;hr>
&lt;h2 id="2-instala√ß√£o">2. Instala√ß√£o&lt;/h2>
&lt;p>A maneira mais f√°cil de iniciar √© utilizando Docker, como em tudo rs. Com isso, voc√™ n√£o precisa se preocupar com a vers√£o do PHP, da extens√£o do Swoole na sua m√°quina, etc.&lt;/p>
&lt;p>Primeiro, crie uma pasta para iniciar o projeto:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">mkdir hyperf-skeleton &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> cd hyperf-skeleton
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Inicie o container mapeando o diret√≥rio que criamos como um volume para receber o projeto:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">docker run -v &lt;span style="color:#e6db74">${&lt;/span>PWD&lt;span style="color:#e6db74">}&lt;/span>:/app -p 9501:9501 -it --entrypoint /bin/sh hyperf/hyperf:7.4-alpine-v3.11-swoole
&lt;/code>&lt;/pre>&lt;/div>&lt;p>J√° dentro do container, instale o Hyperf na pasta &lt;code>app&lt;/code> que mapeamos anteriormente. O framework √© bastante modular, ent√£o ele vai perguntar se voc√™ quer utilizar algumas coisas, inicialmente, escolha todas as op√ß√µes padr√£o que j√° vai nos atender.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">composer create-project hyperf/hyperf-skeleton app
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Caso voc√™ queira iniciar esse projeto novamente de maneira mais f√°cil e j√° cair na raiz do projeto, crie o arquivo do &lt;code>docker-compose.yaml&lt;/code> com o seguinte conte√∫do:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-docker" data-lang="docker">version: &lt;span style="color:#e6db74">&amp;#39;3.9&amp;#39;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>services:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> hyperf-skeleton:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> container_name: hyperf-skeleton&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> image: hyperf/hyperf:7.4-alpine-v3.11-swoole&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> working_dir: /app&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> entrypoint: sh&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> volumes:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> - ./:/app&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> ports:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> - 9501:9501&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Sobre o &lt;code>entrypoint&lt;/code> ser direto o &lt;code>sh&lt;/code> e n√£o o start do projeto, veremos mais tarde o motivo disso. Depois disso, para iniciar o container basta usar o seguinte comando:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">docker compose run --rm --service-ports hyperf-skeleton
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Agora √© s√≥ iniciar o webserver:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">php bin/hyperf.php start
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Sua aplica√ß√£o est√° pronta para responder em: &lt;a href="http://0.0.0.0:9501">http://0.0.0.0:9501&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">{
&lt;span style="color:#f92672">&amp;#34;method&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;GET&amp;#34;&lt;/span>,
&lt;span style="color:#f92672">&amp;#34;message&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Hello Hyperf.&amp;#34;&lt;/span>
}
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>Mais detalhes na &lt;a href="https://hyperf.wiki/2.1/#/en/quick-start/install">documenta√ß√£o oficial&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;hr>
&lt;h2 id="3-hot-reload">3. Hot Reload&lt;/h2>
&lt;p>Como j√° vimos que o Swoole √© executado via &lt;code>PHP CLI&lt;/code>, em ambiente de desenvolvimento isso pode ser ruim, pois podemos perder muito tempo parando e iniciando o servidor. Bom, felizmente o Hyperf resolveu isso de forma f√°cil via o componente &lt;a href="https://hyperf.wiki/2.1/#/en/watcher">Watcher&lt;/a>.&lt;/p>
&lt;blockquote>
&lt;p>Importante: n√£o utilize esse componente em ambiente produtivo, ele √© destinado ao ambiente de desenvolvimento!&lt;/p>
&lt;/blockquote>
&lt;p>Primeiro precisamos instalar esse modulo no nosso projeto:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">composer require hyperf/watcher --dev
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Publicar o arquivo de configura√ß√µes:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">php bin/hyperf.php vendor:publish hyperf/watcher
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Um arquivo foi criado em: &lt;code>config/autoload/watcher.php&lt;/code>, nele voc√™ pode definir as configura√ß√µes que achar melhor, aqui vamos seguir com as que j√° est√£o l√° mesmo.&lt;/p>
&lt;p>Agora, para rodar nosso projeto em &lt;strong>ambiente de desenvolvimento&lt;/strong>, nosso comando passa a ser:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">php bin/hyperf.php server:watch
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Assim, sempre que fizermos alguma altera√ß√£o no projeto, esse componente vai recarregar nosso c√≥digo automaticamente sem ser preciso reiniciar manualmente.&lt;/p>
&lt;p>&lt;img src="images/magic.gif" alt="magic.gif">&lt;/p>
&lt;hr>
&lt;h2 id="4-estrutura">4. Estrutura&lt;/h2>
&lt;p>A estrutura √© bem simples, como comentei √© bem similar ao Laravel, ent√£o n√£o tem muita complexidade. As principais pastas s√£o:&lt;/p>
&lt;ul>
&lt;li>Arquivo de start: &lt;code>bin/hyperf.php&lt;/code>&lt;/li>
&lt;li>Centro de configura√ß√µes: &lt;code>config/*&lt;/code>&lt;/li>
&lt;li>Rotas: &lt;code>config/routes.php&lt;/code>&lt;/li>
&lt;li>Server: &lt;code>config/autoload/server.php&lt;/code>&lt;/li>
&lt;li>Inje√ß√£o de depend√™ncias: &lt;code>config/autoload/dependencies.php&lt;/code>&lt;/li>
&lt;li>Design do projeto: &lt;code>config/autoload/devtool.php&lt;/code>&lt;/li>
&lt;li>Aplica√ß√£o: &lt;code>app/*&lt;/code>&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>Para conhecer mais sobre o centro de configura√ß√µes, acesse &lt;a href="https://hyperf.wiki/2.1/#/en/config-center">este link&lt;/a>.&lt;/p>
&lt;/blockquote>
&lt;p>Eu queria destacar um dos itens acima que achei super interessante, o arquivo &lt;code>devtool.php&lt;/code>. Com ele √© poss√≠vel montar todo o design da sua arquitetura da forma que voc√™ achar melhor. Ou seja, em um √∫nico arquivo voc√™ consegue definir sua estrutura de pastas para utilizar &lt;a href="https://pt.stackoverflow.com/questions/19548/o-que-realmente-%C3%A9-ddd-e-quando-ele-se-aplica">DDD&lt;/a> com &lt;a href="https://medium.com/luizalabs/descomplicando-a-clean-architecture-cf4dfc4a1ac6">clean architecture&lt;/a>, &lt;a href="https://netflixtechblog.com/ready-for-changes-with-hexagonal-architecture-b315ec967749">hexagonal architecture&lt;/a>, ou qualquer outra que desejar, te dando muito poder de trabalhar da forma que preferir.&lt;/p>
&lt;hr>
&lt;h2 id="5-melhorando-o-ambiente">5. Melhorando o ambiente&lt;/h2>
&lt;p>Na pr√≥xima se√ß√£o, vamos iniciar com uma ideia b√°sica de CRUD. Mas antes, vamos fazer uma melhoria no nosso &lt;code>docker-compose.yaml&lt;/code> para ajudar no nosso desenvolvimento, adicionando o nosso banco de dados e o Redis (que vamos utilizar mais adiante).&lt;/p>
&lt;p>Atualize o arquivo &lt;code>docker-compose.yaml&lt;/code> para:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-docker" data-lang="docker">version: &lt;span style="color:#e6db74">&amp;#39;3.9&amp;#39;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>services:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> hyperf-skeleton:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> container_name: hyperf-skeleton&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> image: hyperf/hyperf:7.4-alpine-v3.11-swoole&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> working_dir: /app&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> entrypoint: &lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#e6db74">&amp;#34;php&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;bin/hyperf.php&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;server:watch&amp;#34;&lt;/span>&lt;span style="color:#f92672">]&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> volumes:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> - ./:/app&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> ports:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> - 9501:9501&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> depends_on:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> - hyperf-skeleton-mariadb&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> - hyperf-skeleton-redis&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> hyperf-skeleton-mariadb:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> container_name: hyperf-skeleton-mariadb&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> image: mariadb:latest&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> volumes:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> - ./.docker/mariadb:/var/lib/mysql&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> ports:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> - 3306:3306&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> environment:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> MYSQL_ROOT_PASSWORD: &lt;span style="color:#e6db74">&amp;#34;secret&amp;#34;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> MYSQL_DATABASE: &lt;span style="color:#e6db74">&amp;#34;hyperf-skeleton&amp;#34;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> hyperf-skeleton-redis:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> container_name: hyperf-skeleton-redis&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> image: redis:latest&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> ports:&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span> - 6379:6379&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Agora para iniciar nosso projeto completo basta rodar o seguinte comando:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">docker-compose up -d
&lt;/code>&lt;/pre>&lt;/div>&lt;p>E claro, para remover tudo:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">docker-compose down
&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h2 id="6-database">6. Database&lt;/h2>
&lt;blockquote>
&lt;p>Caso queira entender um pouco mais sobre o que vamos utilizar agora no Hyperf, acesse a documenta√ß√£o oficial e veja sobre: &lt;a href="https://hyperf.wiki/2.1/#/en/db/quick-start">Database&lt;/a>, &lt;a href="https://hyperf.wiki/2.1/#/en/db/model">Model&lt;/a> e &lt;a href="https://hyperf.wiki/2.1/#/en/db/migration">Migration&lt;/a>.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>Dica: evite copiar e colar o c√≥digo, tente escrever tudo, assim seu aprendizado ser√° muito maior (:&lt;/p>
&lt;/blockquote>
&lt;p>Com nosso banco de dados rodando, vamos criar uma migration para a tabela de usu√°rios:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">docker container exec -it hyperf-skeleton php bin/hyperf.php gen:migration create_users_table
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Com o nosso arquivo gerado em &lt;code>migrations/*_create_users_table.php&lt;/code>, vamos inserir os campos b√°sicos para serem criados:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#a6e22e">Schema&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">create&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;users&amp;#39;&lt;/span>, &lt;span style="color:#66d9ef">function&lt;/span> (&lt;span style="color:#a6e22e">Blueprint&lt;/span> $table) {
$table&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">uuid&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;id&amp;#39;&lt;/span>)&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">primary&lt;/span>();
$table&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">string&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;name&amp;#39;&lt;/span>);
$table&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">string&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;email&amp;#39;&lt;/span>);
$table&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">timestamps&lt;/span>();
});
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>Sim, vamos usar &lt;code>uuid&lt;/code> como chave primaria, espero que em todos os seus projetos voc√™ tamb√©m esteja usando üëÄ, se ainda n√£o estiver, da uma olhada &lt;a href="https://mareks-082.medium.com/auto-increment-keys-vs-uuid-a74d81f7476a">aqui&lt;/a>.&lt;/p>
&lt;/blockquote>
&lt;p>O pr√≥ximo passo √© criar o nosso modelo, ent√£o na pasta &lt;code>App/Model&lt;/code> vamos criar o nosso &lt;code>User&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#a6e22e">php&lt;/span> &lt;span style="color:#66d9ef">declare&lt;/span>(&lt;span style="color:#a6e22e">strict_types&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>);
&lt;span style="color:#66d9ef">namespace&lt;/span> &lt;span style="color:#a6e22e">App\Model&lt;/span>;
&lt;span style="color:#66d9ef">use&lt;/span> &lt;span style="color:#a6e22e">Hyperf\DbConnection\Model\Model&lt;/span>;
&lt;span style="color:#e6db74">/**
&lt;/span>&lt;span style="color:#e6db74"> * @property $id
&lt;/span>&lt;span style="color:#e6db74"> * @property $name
&lt;/span>&lt;span style="color:#e6db74"> * @property $email
&lt;/span>&lt;span style="color:#e6db74"> * @property $created_at
&lt;/span>&lt;span style="color:#e6db74"> * @property $updated_at
&lt;/span>&lt;span style="color:#e6db74"> */&lt;/span>
&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">User&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> &lt;span style="color:#a6e22e">Model&lt;/span>
{
&lt;span style="color:#e6db74">/**
&lt;/span>&lt;span style="color:#e6db74"> * @var string
&lt;/span>&lt;span style="color:#e6db74"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> $keyType &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#39;string&amp;#39;&lt;/span>;
&lt;span style="color:#e6db74">/**
&lt;/span>&lt;span style="color:#e6db74"> * @var bool
&lt;/span>&lt;span style="color:#e6db74"> */&lt;/span>
&lt;span style="color:#66d9ef">public&lt;/span> $incrementing &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>;
&lt;span style="color:#e6db74">/**
&lt;/span>&lt;span style="color:#e6db74"> * The attributes that are mass assignable.
&lt;/span>&lt;span style="color:#e6db74"> *
&lt;/span>&lt;span style="color:#e6db74"> * @var array
&lt;/span>&lt;span style="color:#e6db74"> */&lt;/span>
&lt;span style="color:#66d9ef">protected&lt;/span> $fillable &lt;span style="color:#f92672">=&lt;/span> [&lt;span style="color:#e6db74">&amp;#39;id&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;name&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;email&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;created_at&amp;#39;&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;updated_at&amp;#39;&lt;/span>];
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Antes de rodar a nossa migration, normalmente √© preciso verificar se os par√¢metros de conex√£o do banco est√£o devidamente configurados. Por√©m, no nosso caso vamos manter tudo como est√°, mas vale a pena dar uma olhada no conte√∫do do arquivo, ele fica em &lt;code>config/autoload/databases.php&lt;/code>.&lt;/p>
&lt;p>O que vamos precisar fazer √© trocar as &lt;code>envs&lt;/code> no arquivo &lt;code>.env&lt;/code> para realizar a conex√£o ao nosso container. S√≥ vamos precisar alterar as seguintes &lt;code>envs&lt;/code>:&lt;/p>
&lt;pre>&lt;code>DB_HOST=hyperf-skeleton-mariadb
DB_DATABASE=hyperf-skeleton
DB_USERNAME=root
DB_PASSWORD=secret
&lt;/code>&lt;/pre>&lt;p>Agora √© s√≥ rodar a migration no container da aplica√ß√£o:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">docker container exec -it hyperf-skeleton php bin/hyperf.php migrate
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Resultado de sucesso:&lt;/p>
&lt;pre>&lt;code>[INFO] Migration table created successfully.
Migrating: *_create_users_table
Migrated: *_create_users_table
&lt;/code>&lt;/pre>&lt;blockquote>
&lt;p>Importante, o hot reload n√£o funciona para recarregar variaveis de ambiente, ent√£o √© preciso dar um restart manual no container.&lt;/p>
&lt;/blockquote>
&lt;hr>
&lt;h2 id="7-rotas-e-controllers">7. Rotas e Controllers&lt;/h2>
&lt;blockquote>
&lt;p>Caso queira entender um pouco mais sobre o que vamos utilizar agora no Hyperf, acesse a documenta√ß√£o oficial e veja sobre: &lt;a href="https://hyperf.wiki/2.1/#/en/controller">Controller&lt;/a> e &lt;a href="https://hyperf.wiki/2.1/#/en/router">Router&lt;/a>.&lt;/p>
&lt;/blockquote>
&lt;p>Agora vamos criar o nosso &lt;code>UserController&lt;/code>, na pasta &lt;code>app/Controller&lt;/code> inicialmente vazio:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#a6e22e">php&lt;/span> &lt;span style="color:#66d9ef">declare&lt;/span>(&lt;span style="color:#a6e22e">strict_types&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>);
&lt;span style="color:#66d9ef">namespace&lt;/span> &lt;span style="color:#a6e22e">App\Controller&lt;/span>;
&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">UserController&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> &lt;span style="color:#a6e22e">AbstractController&lt;/span>
{
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Depois, precisamos definir nossas rotas. Ent√£o faremos algo assim:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#66d9ef">use&lt;/span> &lt;span style="color:#a6e22e">App\Controller\UserController&lt;/span>;
&lt;span style="color:#a6e22e">Router&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">addGroup&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;/users&amp;#39;&lt;/span>, &lt;span style="color:#66d9ef">function&lt;/span> () {
&lt;span style="color:#a6e22e">Router&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">get&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>, [&lt;span style="color:#a6e22e">UserController&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;index&amp;#39;&lt;/span>]);
&lt;span style="color:#a6e22e">Router&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">get&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;/{id}&amp;#39;&lt;/span>, [&lt;span style="color:#a6e22e">UserController&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;show&amp;#39;&lt;/span>]);
&lt;span style="color:#a6e22e">Router&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">post&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>, [&lt;span style="color:#a6e22e">UserController&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;store&amp;#39;&lt;/span>]);
&lt;span style="color:#a6e22e">Router&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">delete&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;/{id}&amp;#39;&lt;/span>, [&lt;span style="color:#a6e22e">UserController&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;delete&amp;#39;&lt;/span>]);
});
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Voltando para o nosso &lt;code>Controller&lt;/code>, vamos criar os m√©todos conforme nossas rotas j√° utilizando a classe &lt;code>User&lt;/code> e fazendo as devidas opera√ß√µes com o ORM:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#a6e22e">php&lt;/span> &lt;span style="color:#66d9ef">declare&lt;/span>(&lt;span style="color:#a6e22e">strict_types&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>);
&lt;span style="color:#66d9ef">namespace&lt;/span> &lt;span style="color:#a6e22e">App\Controller&lt;/span>;
&lt;span style="color:#66d9ef">use&lt;/span> &lt;span style="color:#a6e22e">App\Model\User&lt;/span>;
&lt;span style="color:#66d9ef">use&lt;/span> &lt;span style="color:#a6e22e">Hyperf\HttpServer\Contract\RequestInterface&lt;/span>;
&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">UserController&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> &lt;span style="color:#a6e22e">AbstractController&lt;/span>
{
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">index&lt;/span>(&lt;span style="color:#a6e22e">RequestInterface&lt;/span> $request)
{
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">User&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">get&lt;/span>();
}
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">show&lt;/span>(&lt;span style="color:#a6e22e">string&lt;/span> $id)
{
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">User&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">find&lt;/span>($id);
}
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">store&lt;/span>(&lt;span style="color:#a6e22e">RequestInterface&lt;/span> $request)
{
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">User&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">create&lt;/span>($request&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">all&lt;/span>());
}
&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">delete&lt;/span>(&lt;span style="color:#a6e22e">string&lt;/span> $id)
{
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">User&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">destroy&lt;/span>($id);
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Essa √© uma estrutura extremamente b√°sica, e com alguns problemas&amp;hellip; Contudo, a ideia n√£o √© ensinar tudo aqui, e sim te direcionar para explorar e construir coisas interessantes. Para isso, vou deixar alguns links aqui para voc√™ melhorar este c√≥digo:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://hyperf.wiki/2.1/#/en/db/paginator">Paginator&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://hyperf.wiki/2.1/#/en/validation">Validation&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://hyperf.wiki/2.1/#/en/cache">Cache&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://hyperf.wiki/2.1/#/en/response">Response&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://hyperf.wiki/2.1/#/en/event">Event Dispatcher&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>Todos os itens acima t√™m uma boa documenta√ß√£o e com bons exemplos. Voc√™ consegue implementar tudo isso nesse simples CRUD para exercitar os recursos do Hyperf.&lt;/p>
&lt;p>Ainda tenho uma ideia b√¥nus: crie uma interface e uma implementa√ß√£o para a Repository Pattern refatorando este c√≥digo e injete via &lt;a href="https://hyperf.wiki/2.1/#/en/di">Dependency Injection&lt;/a>, tenho certeza que ser√° bacana entender este fluxo.&lt;/p>
&lt;p>E claro, n√£o esque√ßa de criar testes. O Hyperf criou o &lt;code>co-phpunit&lt;/code>, que √© basicamente o &lt;code>phpunit&lt;/code> com corrotinas. Maneiro de mais n√©? Para conhecer mais acesse a &lt;a href="https://hyperf.wiki/2.1/#/en/testing">documenta√ß√£o&lt;/a>.&lt;/p>
&lt;hr>
&lt;h2 id="8-parallel">8. Parallel&lt;/h2>
&lt;p>Outra coisa que achei muito bacana, foi a implementa√ß√£o que o Hyperf fez do gerenciamento via channels de corrotinas usando wait groups e handle de exceptions. Basicamente ele encapsulou toda essa implementa√ß√£o na classe &lt;code>Hyperf\Utils\Parallel&lt;/code>.&lt;/p>
&lt;p>Usando o exemplo do que fizemos acima, para criar v√°rios usu√°rios em paralelo e s√≥ continuar depois que todos finalizarem, podemos fazer assim no nosso &lt;code>UserController@store&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">store&lt;/span>(&lt;span style="color:#a6e22e">RequestInterface&lt;/span> $request)
{
$parallel &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Parallel&lt;/span>();
&lt;span style="color:#66d9ef">foreach&lt;/span> ($request&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">input&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;users&amp;#39;&lt;/span>) &lt;span style="color:#66d9ef">as&lt;/span> $user) {
$parallel&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>(
&lt;span style="color:#66d9ef">function&lt;/span> () &lt;span style="color:#66d9ef">use&lt;/span> ($user) {
&lt;span style="color:#a6e22e">User&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">create&lt;/span>($user);
},
$user[&lt;span style="color:#e6db74">&amp;#39;id&amp;#39;&lt;/span>]
);
}
&lt;span style="color:#66d9ef">return&lt;/span> $parallel&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">wait&lt;/span>();
}
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>Claro que n√£o fariamos esta implementa√ß√£o no mundo real, √© apenas um exemplo rsrs.&lt;/p>
&lt;/blockquote>
&lt;p>√â importante destacar que ao disparar uma corrotina, tudo que for utilizado de I/O dentro do seu contexto precisa ser compat√≠vel com corrotinas, caso contr√°rio seu c√≥digo ser√° bloqueante.&lt;/p>
&lt;p>Todos os componentes do Hyperf j√° s√£o compat√≠veis, ent√£o voc√™ pode utilizar sem problemas, tenha aten√ß√£o apenas com bibliotecas como a do &lt;code>mongodb&lt;/code>, que, at√© o momento n√£o tem suporte dos &lt;a href="https://www.swoole.co.uk/docs/modules/swoole-runtime-flags">Hooks do Swoole&lt;/a>.&lt;/p>
&lt;hr>
&lt;h2 id="9-benchmark">9. Benchmark&lt;/h2>
&lt;p>Falamos muito sobre performance, diferen√ßas entre o Swoole e o &amp;ldquo;PHP Tradicional&amp;rdquo;, mas agora vamos aos n√∫meros!&lt;/p>
&lt;p>Realizei um teste na minha pr√≥pria m√°quina, ent√£o os resultados podem ser diferentes de um servidor em produ√ß√£o ou da sua m√°quina. N√£o vamos focar nos n√∫meros absolutos, vamos focar nas refer√™ncias entre um e outro, pois mesmo mudando de ambiente, provavelmente ser√£o mantidas similares.&lt;/p>
&lt;blockquote>
&lt;p>Para realizar os testes utilizei o &lt;a href="https://github.com/wg/wrk">wrk&lt;/a> na rota de retorno base dos frameworks.&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>Laravel 8 com PHP 7.4 (93 rq/s)&lt;/strong>&lt;/p>
&lt;pre>&lt;code>Running 10s test @ http://0.0.0.0:8000
12 threads and 400 connections
Thread Stats Avg Stdev Max +/- Stdev
Latency 550.01ms 335.24ms 1.12s 63.01%
Req/Sec 12.38 8.80 70.00 84.72%
938 requests in 10.10s, 16.64MB read
Socket errors: connect 155, read 1214, write 12, timeout 0
Requests/sec: 92.83
Transfer/sec: 1.65MB
&lt;/code>&lt;/pre>&lt;p>&lt;strong>Lumen 8 com PHP 7.4 (279 rq/s)&lt;/strong>&lt;/p>
&lt;pre>&lt;code>Running 10s test @ http://0.0.0.0:8000
12 threads and 400 connections
Thread Stats Avg Stdev Max +/- Stdev
Latency 108.93ms 41.13ms 193.70ms 76.31%
Req/Sec 73.96 40.36 184.00 69.49%
2820 requests in 10.10s, 751.82KB read
Socket errors: connect 157, read 3987, write 4, timeout 0
Requests/sec: 279.10
Transfer/sec: 74.41KB
&lt;/code>&lt;/pre>&lt;p>&lt;strong>Laravel Octane com PHP 8.0 e Swoole (1.273 rq/s)&lt;/strong>&lt;/p>
&lt;pre>&lt;code>Running 10s test @ http://0.0.0.0:8000
12 threads and 400 connections
Thread Stats Avg Stdev Max +/- Stdev
Latency 110.06ms 190.13ms 1.65s 84.78%
Req/Sec 118.57 96.64 550.00 69.97%
12796 requests in 10.05s, 13.09MB read
Socket errors: connect 157, read 101, write 4, timeout 0
Requests/sec: 1273.75
Transfer/sec: 1.30MB
&lt;/code>&lt;/pre>&lt;p>&lt;strong>Hyperf 2.1 com PHP 7.4 (90.799 rq/s)&lt;/strong>&lt;/p>
&lt;pre>&lt;code>Running 10s test @ http://0.0.0.0:9502
12 threads and 400 connections
Thread Stats Avg Stdev Max +/- Stdev
Latency 628.86us 2.28ms 127.72ms 97.39%
Req/Sec 20.96k 12.14k 62.60k 69.07%
914415 requests in 10.07s, 165.69MB read
Socket errors: connect 155, read 84, write 0, timeout 2
Requests/sec: 90799.66
Transfer/sec: 16.45MB
&lt;/code>&lt;/pre>&lt;p>&lt;strong>Swoole puro com PHP 8.0 (159.581 rq/s)&lt;/strong>&lt;/p>
&lt;pre>&lt;code>Running 10s test @ http://0.0.0.0:9501
12 threads and 400 connections
Thread Stats Avg Stdev Max +/- Stdev
Latency 1.47ms 431.57us 29.87ms 97.10%
Req/Sec 13.37k 5.49k 25.36k 59.74%
1612224 requests in 10.10s, 267.53MB read
Socket errors: connect 157, read 107, write 0, timeout 0
Requests/sec: 159581.95
Transfer/sec: 26.48MB
&lt;/code>&lt;/pre>&lt;p>Compara√ß√µes usando o mais lento como refer√™ncia:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Framework&lt;/th>
&lt;th>rq/s&lt;/th>
&lt;th>ref.&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Laravel&lt;/td>
&lt;td>92&lt;/td>
&lt;td>x1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Lumen&lt;/td>
&lt;td>279&lt;/td>
&lt;td>+3x&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Laravel Octane&lt;/td>
&lt;td>1.273&lt;/td>
&lt;td>+13x&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Hyperf&lt;/td>
&lt;td>90.799&lt;/td>
&lt;td>+986x&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Swoole puro&lt;/td>
&lt;td>159.581&lt;/td>
&lt;td>+1.734x&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>Ou seja, o Hyperf √© mais de 986 vezes mais r√°pido do que o Laravel e o Swoole puro 1.734, isso sem considerar a lat√™ncia, que tamb√©m teve uma diferen√ßa enorme. Incr√≠vel n√©? Claro, este √© um benchmark realizado localmente em uma rota extremamente simples, mas a diferen√ßa realmente √© insana, mesmo em outros ambientes.&lt;/p>
&lt;hr>
&lt;p>O resultado deste projeto est√° no meu github:&lt;/p>
&lt;p>&lt;a href="https://github.com/leocarmo/hyperf-skeleton">https://github.com/leocarmo/hyperf-skeleton&lt;/a>&lt;/p>
&lt;p>Bom, acredito que passamos pelo b√°sico do Hyperf, agora voc√™ j√° consegue explorar tudo que ele pode fornecer com este ambiente que iniciamos.&lt;/p>
&lt;p>Pretendo escrever novos artigos aprofundando mais em assuntos espec√≠ficos, principalmente sobre os diversos clients que ele implementa e sobre as &lt;a href="https://hyperf.wiki/2.1/#/en/pool">connections pools&lt;/a>.&lt;/p>
&lt;p>Espero que voc√™ tenha gostado e que esse guia possa ter te ajudado. Apesar de algumas partes da documenta√ß√£o ainda n√£o ter sido traduzida, ela √© bem completa de exemplos, ent√£o da para implementar praticamente tudo que est√° dispon√≠vel.&lt;/p>
&lt;p>E a√≠, j√° conhecia o Hyperf? Me conta o que achou dele nos coment√°rios. (:&lt;/p>
&lt;hr>
&lt;blockquote>
&lt;p>Agradecimento especial ao &lt;a href="https://www.linkedin.com/in/ronieneubauer/">@ronieneubauer&lt;/a> pela revis√£o.&lt;/p>
&lt;/blockquote></content></item><item><title>Guia: Alta performance com PHP ‚Äî Suas aplica√ß√µes backend no pr√≥ximo n√≠vel</title><link>/guia-alta-performance-com-php-suas-aplicacoes-backend-no-proximo-nivel/</link><pubDate>Tue, 12 May 2020 19:30:00 -0300</pubDate><guid>/guia-alta-performance-com-php-suas-aplicacoes-backend-no-proximo-nivel/</guid><description>Muitas pessoas dizem que alta performance e PHP n√£o existem na mesma frase. Se voc√™ ainda pensa assim, vou te provar o contr√°rio.
O PHP √© muito poderoso, s√≥ depende de n√≥s utiliz√°-lo da melhor forma. Meu objetivo com esta publica√ß√£o √© ajudar nesta jornada.
Todo mundo j√° sabe que grandes empresas usam PHP, mas esse n√£o √© o argumento mais forte ao se falar sobre este assunto.
Argumentos fortes s√£o: aplica√ß√µes poderosas, resolu√ß√µes de problemas de forma inteligente e implementa√ß√µes diferentes do comum.</description><content>&lt;p>Muitas pessoas dizem que alta performance e PHP n√£o existem na mesma frase. Se voc√™ ainda pensa assim, vou te provar o contr√°rio.&lt;/p>
&lt;p>O PHP √© muito poderoso, s√≥ depende de n√≥s utiliz√°-lo da melhor forma. Meu objetivo com esta publica√ß√£o √© ajudar nesta jornada.&lt;/p>
&lt;p>Todo mundo j√° sabe que grandes empresas usam PHP, mas esse n√£o √© o argumento mais forte ao se falar sobre este assunto.&lt;/p>
&lt;p>Argumentos fortes s√£o: aplica√ß√µes poderosas, resolu√ß√µes de problemas de forma inteligente e implementa√ß√µes diferentes do comum. E vamos falar muito sobre isso aqui!&lt;/p>
&lt;p>N√£o vou abordar apenas t√≥picos voltados ao c√≥digo, a ideia √© falar sobre o ambiente como um todo: arquitetura, implementa√ß√µes e, claro, c√≥digo.&lt;/p>
&lt;p>Um ponto importante √© que vamos focar exclusivamente em aplica√ß√µes backend, funcionando sem renderiza√ß√£o de views. Pois, caso sua aplica√ß√£o seja full stack, muitas outras otimiza√ß√µes ainda precisam ser feitas.&lt;/p>
&lt;p>Come√ßaremos do b√°sico e vamos aprofundando em assuntos mais complexos aos poucos. Alguns t√≥picos irei apenas trazer ideias iniciais, e depois te direcionar para outras publica√ß√µes onde voc√™ possa estudar e entender mais sobre eles.&lt;/p>
&lt;p>Quero te guiar pelas melhores pr√°ticas para conseguir, de fato, elevar o n√≠vel das suas aplica√ß√µes de forma f√°cil e objetiva. Ent√£o bora l√°!&lt;/p>
&lt;h4 id="t√≥picos">T√≥picos&lt;/h4>
&lt;ol>
&lt;li>&lt;a href="#1-atualize-tudo-sempre">Atualize TUDO, sempre!&lt;/a>&lt;/li>
&lt;li>&lt;a href="#2-refatore-sua-infraestrutura">Refatore sua infraestrutura&lt;/a>&lt;/li>
&lt;li>&lt;a href="#3-boas-pr%C3%A1ticas-e-padr%C3%B5es-de-projeto">Boas pr√°ticas e padr√µes de projeto&lt;/a>&lt;/li>
&lt;li>&lt;a href="#4-frameworks">Frameworks&lt;/a>&lt;/li>
&lt;li>&lt;a href="#5-otimizando-o-php-fpm">Otimizando o PHP-FPM&lt;/a>&lt;/li>
&lt;li>&lt;a href="#6-o-poder-do-opcache">O poder do OPcache&lt;/a>&lt;/li>
&lt;li>&lt;a href="#7-utilize-cache-em-mem%C3%B3ria">Utilize cache em mem√≥ria&lt;/a>&lt;/li>
&lt;li>&lt;a href="#8-conex%C3%B5es-persistentes">Conex√µes persistentes&lt;/a>&lt;/li>
&lt;li>&lt;a href="#9-fun%C3%A7%C3%B5es-nativas">Fun√ß√µes nativas&lt;/a>&lt;/li>
&lt;li>&lt;a href="#10-preloading">Preloading&lt;/a>&lt;/li>
&lt;li>&lt;a href="#11-generators">Generators&lt;/a>&lt;/li>
&lt;li>&lt;a href="#12-c%C3%B3digo-ass%C3%ADncrono">C√≥digo ass√≠ncrono&lt;/a>&lt;/li>
&lt;li>&lt;a href="#13-non-blocking-io-com-php">Non-blocking I/O com PHP&lt;/a>&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h2 id="1-atualize-tudo-sempre">1. Atualize TUDO, sempre!&lt;/h2>
&lt;p>√â, parece bem √≥bvio. Mas quando foi a √∫ltima vez que voc√™ atualizou as depend√™ncias do seu projeto? E a vers√£o do PHP?&lt;/p>
&lt;p>De acordo com a &lt;a href="https://w3techs.com/technologies/details/pl-php">W3Techs&lt;/a>, o PHP √© utilizado por 78.2% de todos os websites, considerando sua linguagem de backend.&lt;/p>
&lt;blockquote>
&lt;p>WOOW THAT‚ÄôS AWESOME!&lt;/p>
&lt;/blockquote>
&lt;p>Nem tanto‚Ä¶ Essa √© uma das raz√µes de muita gente n√£o gostar de PHP e falar coisas bem ruins (digamos que, nesse caso, n√£o est√£o errados).&lt;/p>
&lt;p>A vers√£o 7 √© utilizada por apenas 50.8% desses websites. Ou seja, a outra metade est√° utilizando uma vers√£o terr√≠vel‚Ä¶&lt;/p>
&lt;p>&lt;img src="images/1.png" alt="1.1.png">&lt;/p>
&lt;p>E ainda fica pior, mesmo na vers√£o 7, menos de 30% est√£o utilizando uma vers√£o com suporte ativo, analisando o dia que estou escrevendo. E apenas 3.6% est√£o na ultima vers√£o est√°vel dispon√≠vel (7.4), o que √© p√©ssimo!&lt;/p>
&lt;p>&lt;img src="images/2.png" alt="1.2.png">&lt;/p>
&lt;p>Mas o que isso tem a ver com performance? TUDO! Alem de ficar cada vez mais perform√°tico, muitas atualiza√ß√µes de seguran√ßa s√£o lan√ßadas, o que j√° seria suficiente para voc√™ atualizar seu PHP.&lt;/p>
&lt;blockquote>
&lt;p>Lembre-se: alem do PHP, √© preciso atualizar suas depend√™ncias do composer e suas extens√µes!&lt;/p>
&lt;/blockquote>
&lt;p>Para ver um pouco mais sobre testes de performance, acesse &lt;a href="https://kinsta.com/blog/php-benchmarks/">este link&lt;/a>.&lt;/p>
&lt;p>&lt;img src="images/3.png" alt="1.3.png">&lt;/p>
&lt;p>E o &lt;a href="https://stitcher.io/blog/new-in-php-8">8.0 vem a√≠&lt;/a> com novidades e, claro, mais &lt;a href="https://thephp.website/br/edicao/php-8-jit/">melhorias em performance&lt;/a>. Aqui falamos apenas do PHP, mas temos extens√µes e bibliotecas tamb√©m, ent√£o: atualize TUDO, sempre!&lt;/p>
&lt;hr>
&lt;h2 id="2-refatore-sua-infraestrutura">2. Refatore sua infraestrutura&lt;/h2>
&lt;p>Mais uma coisa √≥bvia? Talvez. Mas sabemos que muitos sistemas rodam tudo no mesmo servidor: banco de dados, aplica√ß√£o, webserver, cache, sistema de arquivos‚Ä¶&lt;/p>
&lt;p>Algumas pessoas justificam isso dizendo que √© para redu√ß√£o de custos. De in√≠cio tudo bem, mas se seu sistema come√ßar a crescer, essa conta n√£o vai ficar barata. Dividir processamento entre diversos processos vai degradar a performance como um todo, mesmo com muito recurso dispon√≠vel.&lt;/p>
&lt;p>Dividir os servi√ßos que voc√™ utiliza, permite um gerenciamento por demanda dos recursos. Ou seja, caso seu banco precise de mais mem√≥ria, apenas ele sofre um upgrade pontual, sem precisar ter uma m√°quina gigante com tudo dentro.&lt;/p>
&lt;p>Essa refatora√ß√£o com certeza vai melhorar a performance do seu sistema como um todo e, dependendo do n√≠vel de tr√°fego, tamb√©m vai reduzir seus custos e complexidade de gerenciamento.&lt;/p>
&lt;p>Alguns servi√ßos e dicas que podem ajudar:&lt;/p>
&lt;ul>
&lt;li>Nginx no lugar do Apache (&lt;a href="https://serverguy.com/comparison/apache-vs-nginx/">Por qu√™?&lt;/a> / &lt;a href="https://www.nginx.com/blog/tuning-nginx/">Como?&lt;/a>)&lt;/li>
&lt;li>Utilize &lt;a href="https://dzone.com/articles/top-10-benefits-of-using-docker">Docker&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/Welcome.html">Elastic container service&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://aws.amazon.com/rds/?nc1=h_ls">Relational database service&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://aws.amazon.com/s3/?nc1=h_ls">Cloud object storage&lt;/a>&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>Voc√™ pode usar qualquer cloud provider, os links s√£o para que voc√™ conhe√ßa mais sobre este tipo de servi√ßo gerenciado.&lt;/p>
&lt;/blockquote>
&lt;p>Esse √© o b√°sico para que voc√™ comece a refatorar sua infraestrutura. Existem muitos outros servi√ßos interessantes que tamb√©m podem ajudar, vamos falar sobre alguns deles em outros t√≥picos.&lt;/p>
&lt;hr>
&lt;h2 id="3-boas-pr√°ticas-e-padr√µes-de-projeto">3. Boas pr√°ticas e padr√µes de projeto&lt;/h2>
&lt;p>N√£o vou abordar cada padr√£o de projeto aqui, a ideia √© ressaltar a import√¢ncia de levar tudo isso muito a s√©rio.&lt;/p>
&lt;p>Por mais que sempre lemos essas palavras por a√≠, estamos realmente colocando isso em pr√°tica? Dentre todos os benef√≠cios, performance com certeza est√° entre eles.&lt;/p>
&lt;p>Podemos destacar a &lt;a href="https://szymonkrajewski.pl/why-should-you-return-early/">early return pattern&lt;/a>, que influencia diretamente a performance das aplica√ß√µes quando trabalhamos com altas volumetrias. Quanto mais r√°pido conseguirmos responder uma requisi√ß√£o, mais r√°pido estaremos prontos para a pr√≥xima!&lt;/p>
&lt;p>Utilizar padr√µes de projeto e boas pr√°ticas √© trazer solu√ß√µes inteligentes e perform√°ticas para suas aplica√ß√µes, ent√£o, sempre que fizer sentido, utilize!&lt;/p>
&lt;blockquote>
&lt;p>Mas aten√ß√£o, &lt;a href="https://en.wikipedia.org/wiki/KISS_principle">KISS&lt;/a>! Padr√µes n√£o s√£o solu√ß√µes para tudo, saiba utilizar de forma inteligente e n√£o como bala de prata.&lt;/p>
&lt;/blockquote>
&lt;p>Alguns materiais para se aprofundar no assunto:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://sourcemaking.com/design_patterns">Design patterns&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://scotch.io/bar-talk/s-o-l-i-d-the-first-five-principles-of-object-oriented-design">SOLID&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.php-fig.org/psr/">PHP Standards Recommendations&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">Don‚Äôt repeat yourself&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/leocarmo/circuit-breaker-php">Circuit Breaker Pattern&lt;/a>&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="4-frameworks">4. Frameworks&lt;/h2>
&lt;p>Este sempre acaba sendo um assunto pol√™mico. Ent√£o, vamos tirar um pouco o foco apenas da perfomance e pensar em outros t√≥picos importantes para este assunto.&lt;/p>
&lt;p>A escolha de um framework tem que levar outros aspectos em considera√ß√£o, entre eles gostaria de destacar alguns:&lt;/p>
&lt;ul>
&lt;li>A equipe est√° confort√°vel em trabalhar com ele?&lt;/li>
&lt;li>A comunidade √© ativa?&lt;/li>
&lt;li>Ele √© atualizado com qual frequ√™ncia?&lt;/li>
&lt;li>A documenta√ß√£o √© bem estruturada?&lt;/li>
&lt;li>J√° pensou em usar um micro-framework?&lt;/li>
&lt;/ul>
&lt;p>Estes s√£o pontos que podem influenciar o futuro da sua aplica√ß√£o, pois, se n√£o for atualizado com frequ√™ncia, sua performance pode ser degradada. Se a comunidade n√£o estiver ativa o suficiente, o mesmo pode acontecer.&lt;/p>
&lt;p>Ent√£o, ao escolher, leve em considera√ß√£o outros aspectos importantes.&lt;/p>
&lt;hr>
&lt;h2 id="5-otimizando-o-php-fpm">5. Otimizando o PHP-FPM&lt;/h2>
&lt;p>Iniciando os t√≥picos um pouco mais avan√ßados, vamos falar sobre o &lt;a href="https://www.php.net/manual/en/install.fpm.php">php-fpm&lt;/a>. Aqui, vamos considerar que voc√™ j√° utiliza o Nginx com o php-fpm e que j√° &lt;a href="https://www.inmotionhosting.com/support/website/php-fpm-the-future-of-php-handling/">saiba como ele funciona&lt;/a>, pelo menos de forma b√°sica. Se n√£o utiliza, a primeira recomenda√ß√£o √© mudar para essa combina√ß√£o extremamente poderosa.&lt;/p>
&lt;p>As configura√ß√µes que vamos abordar aqui, leva em considera√ß√£o que seu sistema tem um grande volume de requisi√ß√µes.&lt;/p>
&lt;p>Vamos focar aqui na configura√ß√£o dos processos que ser√£o abertos e gerenciados pelo fpm. Com isso, a melhor forma de gerenciar estes processos em alta volumetria √© de forma est√°tica. Assim, o fpm n√£o vai precisar se preocupar em aumentar ou diminuir cada um deles.&lt;/p>
&lt;p>Outro ponto importante √© a quantidade de requisi√ß√µes que cada processo ir√° processar antes de ser renovado. Temos que pensar no equil√≠brio, pois, enquanto um n√∫mero muito alto pode causar um &lt;a href="https://medium.com/@FreeDev/tenha-cuidado-com-o-memory-leak-b171622b4c6b">memory leak&lt;/a>, um n√∫mero muito baixo pode fazer com que, a todo momento, o fpm tenha que lidar com o start de um novo processo. Ent√£o saiba quanto cada uma das suas requisi√ß√µes utiliza de mem√≥ria para ajustar essa configura√ß√£o, para isso fa√ßa &lt;a href="https://stackify.com/php-profiling-find-slow-code/">profilling&lt;/a>!&lt;/p>
&lt;p>Sendo assim, um exemplo de configura√ß√£o seria:&lt;/p>
&lt;pre>&lt;code>[api]
pm = static
pm.max_children = 16
pm.max_requests = 10000
&lt;/code>&lt;/pre>&lt;p>Com workers est√°ticos j√° teremos uma grande diferen√ßa. Claro, existem diversas outras configura√ß√µes, ent√£o para saber um pouco mais, aqui tem &lt;a href="https://geekflare.com/php-fpm-optimization/">um artigo&lt;/a> abordando mais sobre este assunto.&lt;/p>
&lt;hr>
&lt;h2 id="6-o-poder-do-opcache">6. O poder do OPcache&lt;/h2>
&lt;p>Esta √© uma extens√£o muito poderosa para o PHP, se voc√™ n√£o utiliza, pare tudo e implemente o quanto antes! Para uma r√°pida introdu√ß√£o, o que diz a &lt;a href="https://www.php.net/manual/en/book.opcache.php">documenta√ß√£o&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>OPcache improves PHP performance by storing precompiled script bytecode in shared memory, thereby removing the need for PHP to load and parse scripts on each request.&lt;/p>
&lt;/blockquote>
&lt;p>Com isso, j√° da pra sentir o poder que ele pode dar para suas aplica√ß√µes. Todo o sistema ser√° compilado apenas uma vez e estar√° dispon√≠vel em mem√≥ria para as pr√≥ximas requisi√ß√µes. Show!&lt;/p>
&lt;p>Um benchmark para mostrar o poder do OPcache:&lt;/p>
&lt;p>&lt;img src="images/4.png" alt="opcache.png">&lt;/p>
&lt;blockquote>
&lt;p>&lt;a href="https://www.ibexa.co/blog/benchmarking-php-7.3-vs-7.4-with-symfony-4.4-trouble-with-opcache-preloading">Fonte da imagem&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>Come√ßar a utilizar √© muito f√°cil, basta instalar, configurar e pronto! Por√©m, como aponta a documenta√ß√£o, todos os scripts v√£o para mem√≥ria. Isso significa que, caso n√£o utilize container, ao atualizar seu projeto, √© preciso dar um reload no seu processo do fpm para que ele limpe os scripts antigos e recompile os novos.&lt;/p>
&lt;p>Vou deixar aqui uma configura√ß√£o bem interessante para iniciar:&lt;/p>
&lt;pre>&lt;code>[opcache]
opcache.enable=1
opcache.memory_consumption=128
opcache.max_accelerated_files=4000
opcache.validate_timestamps=0
opcache.interned_strings_buffer=12
opcache.use_cwd=0
&lt;/code>&lt;/pre>&lt;p>Existem &lt;a href="https://www.php.net/manual/en/opcache.configuration.php">diversas configura√ß√µes dispon√≠veis&lt;/a>, basta dar uma olhada na documenta√ß√£o e configurar conforme fizer sentido para sua aplica√ß√£o. Para saber mais sobre o OPcache, existem muitos materiais bacanas dispon√≠veis, &lt;a href="https://www.cloudways.com/blog/integrate-php-opcache/">aqui tem um&lt;/a>.&lt;/p>
&lt;hr>
&lt;h2 id="7-utilize-cache-em-mem√≥ria">7. Utilize cache em mem√≥ria&lt;/h2>
&lt;p>&amp;ldquo;Cachear&amp;rdquo; sua aplica√ß√£o de forma inteligente pode ser uma das coisas mais importantes para se obter um ganho expressivo em performance e redu√ß√£o de custos.&lt;/p>
&lt;p>Sabe quando voc√™ precisa utilizar um mesmo c√≥digo em dois lugares diferentes e, para isso, voc√™ cria um m√©todo que possui esse mesmo &amp;ldquo;trabalho&amp;rdquo; a ser feito? Utilizar cache √© basicamente armazenar um trabalho j√° feito para ser reaproveitado.&lt;/p>
&lt;p>Os ganhos? Performance claro, se aquele trabalho demorava 1s, usando cache pode chegar a demorar 5ms. Sim, √© muito poderoso. E isso nos leva a redu√ß√£o de custos, na aplica√ß√£o e no banco de dados, pois a ideia √© reduzir as chamadas ao banco tamb√©m.&lt;/p>
&lt;p>N√£o existe uma estrat√©gia pronta para isso, quem define √© voc√™. Mas o direcionamento do pensamento √©: posso reutilizar um trabalho j√° feito para as pr√≥ximas requisi√ß√µes? Um exemplo pr√°tico e simples: um blog possui uma sess√£o de &amp;ldquo;mais visualizados&amp;rdquo;, para isso, √© preciso pegar todas as publica√ß√µes e ordena-las pelo n√∫mero de views. A cada requisi√ß√£o voc√™ realmente precisa fazer isso? Ou pode armazenar esse trabalho durante um tempo? Ent√£o utilize cache por 30m por exemplo. Pode confiar, os ganhos s√£o infinitos!&lt;/p>
&lt;p>Falando de cache em alta performance, eu focaria em duas op√ß√µes: &lt;a href="https://redis.io/">Redis&lt;/a> ou &lt;a href="https://memcached.org/">Memcached&lt;/a>. Existem outras alternativas, mas eu iria com um deles, e entre os dois: Redis. Al√©m de mais perform√°tico, ele possui diversas &lt;a href="https://aws.amazon.com/elasticache/redis-vs-memcached/">outras vantagens&lt;/a>.&lt;/p>
&lt;p>&lt;img src="images/5.png" alt="7.png">&lt;/p>
&lt;blockquote>
&lt;p>&lt;a href="http://oldblog.antirez.com/post/redis-memcached-benchmark.html">Fonte do benchmark&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>B√¥nus:&lt;/strong> utilizando &lt;a href="https://github.com/phpredis/phpredis">essa extens√£o&lt;/a> do Redis para PHP, voc√™ tem ainda mais poder de otimiza√ß√£o e assume o controle total do Redis de forma f√°cil e eficiente. √â poss√≠vel, por exemplo, armazenar suas sess√µes do PHP no Redis, ou seja, n√£o precisa mais se preocupar com a performance do storage da aplica√ß√£o, sua aplica√ß√£o vai voar! :)&lt;/p>
&lt;hr>
&lt;h2 id="8-conex√µes-persistentes">8. Conex√µes persistentes&lt;/h2>
&lt;p>Esse √© um assunto que vi sendo abordado poucas vezes, quando o assunto √© performance. Conex√µes persistentes s√£o muito poderosas para trabalhar em alta volumetria.&lt;/p>
&lt;p>Na verdade, ouvimos falar sobre &lt;a href="https://en.wikipedia.org/wiki/HTTP_persistent_connection">conex√µes http persistentes&lt;/a>, mas elas n√£o s√£o as √∫nicas que sua aplica√ß√£o precisa lidar. Temos tamb√©m ao banco de dados e ao Redis, por exemplo.&lt;/p>
&lt;p>Vou utilizar a do banco de dados como exemplo. Lembra do php-fpm que gerencia seus processos? Certo! Vamos pensar que ele processou as 10 mil requisi√ß√µes que configuramos e que todas as requisi√ß√µes precisaram ir ao banco de dados duas vezes. Com uma conex√£o tradicional, apenas uma seria aberta para realizar as duas queries, show! Mas pensando em um ambiente macro, nessas 10 mil requisi√ß√µes ter√≠amos que fazer isso 10 mil vezes!&lt;/p>
&lt;p>O recurso computacional exigido nesse processo, tanto da aplica√ß√£o, quanto do banco de dados √© de se levar em considera√ß√£o. Com isso, podemos utilizar as conex√µes persistentes e reaproveitar uma conex√£o j√° aberta para esse processo e com certeza ter um ganho expressivo em recursos e performance, claro.&lt;/p>
&lt;p>E para utilizar √© bem simples, basta passar o par√¢metro de configura√ß√£o &lt;code>PDO::ATTR_PERSISTENT&lt;/code> ao driver de conex√£o como &lt;code>true&lt;/code>. Para saber um pouco mais vale conferir a &lt;a href="https://www.php.net/manual/en/pdo.connections.php">documenta√ß√£o oficial&lt;/a>.&lt;/p>
&lt;p>Caso queira ler um pouco mais, vou deixar um &lt;a href="https://www.valinv.com/dev/mysql-mysql-persistent-connections-in-php">link interessante aqui&lt;/a> sobre conex√µes persistentes ao banco de dados.&lt;/p>
&lt;p>Ao utilizar o Redis com &lt;a href="https://github.com/phpredis/phpredis#pconnect-popen">PhpRedis&lt;/a> (o mais recomendado), basta mudar a forma de conectar para &lt;code>$redis-&amp;gt;pconnect()&lt;/code> , simples assim!&lt;/p>
&lt;hr>
&lt;h2 id="9-fun√ß√µes-nativas">9. Fun√ß√µes nativas&lt;/h2>
&lt;p>Bom, todos sabemos que &lt;a href="https://www.php.net/manual/en/indexes.functions.php">elas existem&lt;/a>. Mas realmente usamos? Aqui tem um &lt;a href="https://www.exakat.io/top-100-php-functions/">top 100&lt;/a> das fun√ß√µes nativas mais utilizadas em projetos open source. N√£o quero entrar no m√©rito se foram bem utilizadas ou n√£o, mas √© um ranking interessante para analisar quais s√£o mais utilizadas e dar um primeiro passo.&lt;/p>
&lt;p>Hoje em dia, eu quase nunca utilizo loops na m√£o. Isso porque consigo resolver quase tudo com fun√ß√µes nativas, que s√£o mais perform√°ticas. Elas tamb√©m ajudam bastante quando pensamos em manuten√ß√£o de c√≥digo, pois facilitam o entendimento na hora de ler.&lt;/p>
&lt;p>Um teste r√°pido, qual voc√™ consegue entender mais r√°pido?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#75715e">// Job
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">cube&lt;/span>($number) {
&lt;span style="color:#66d9ef">return&lt;/span> ($number &lt;span style="color:#f92672">*&lt;/span> $number &lt;span style="color:#f92672">*&lt;/span> $number);
}
&lt;span style="color:#75715e">// Without native
&lt;/span>&lt;span style="color:#75715e">&lt;/span>$cubes &lt;span style="color:#f92672">=&lt;/span> [];
&lt;span style="color:#66d9ef">foreach&lt;/span>($numbers &lt;span style="color:#66d9ef">as&lt;/span> $number) {
$cubes[] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">cube&lt;/span>($number);
}
&lt;span style="color:#75715e">// With native
&lt;/span>&lt;span style="color:#75715e">&lt;/span>$cubes &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">array_map&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;cube&amp;#39;&lt;/span>, $numbers);
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Fiz um &lt;a href="https://gist.github.com/leocarmo/4a1320da1b61523c0c8d00ef2a3524e3">benchmark r√°pido&lt;/a> com esse c√≥digo, e utilizando &lt;code>array_map&lt;/code> consegui um resultado quase 15% mais perform√°tico, testando um array com 1.000.000 elementos 1.000 vezes.&lt;/p>
&lt;p>Uma outra solu√ß√£o que gosto bastante √© utilizar &lt;a href="https://laravel.com/docs/7.x/collections">Laravel Collections&lt;/a>. O c√≥digo fica mais limpo e leg√≠vel, al√©m de utilizar diversas fun√ß√µes nativas &amp;ldquo;por baixo&amp;rdquo;.&lt;/p>
&lt;hr>
&lt;h2 id="10-preloading">10. Preloading&lt;/h2>
&lt;p>O PHP 7.4 veio com uma novidade bem bacana, o preloading do &lt;a href="https://leonardocarmo.medium.com/guia-alta-performance-com-php-suas-aplica%C3%A7%C3%B5es-backend-no-pr%C3%B3ximo-n%C3%ADvel-c0a3ca9aed10#9c93">OPcache&lt;/a>, que falamos ali em cima. Resolvi falar sobre isso separadamente para entrar um pouco mais no detalhe, e por serem coisas diferentes mas complementares.&lt;/p>
&lt;p>&lt;strong>E qual a diferen√ßa, na pr√°tica, em usar esse preloading?&lt;/strong>&lt;/p>
&lt;p>Como j√° sabemos, a principal caracter√≠stica do OPcache √© armazenar os arquivos j√° compilados (&amp;ldquo;opcodes&amp;rdquo;) em mem√≥ria para serem reutilizados. Certo, j√° falamos sobre isso. Mas ele faz isso sem relacionar tudo que foi compilado e n√£o consegue resolver depend√™ncias entre as classes quando chegar uma requisi√ß√£o, ou seja, j√° est√° tudo em mem√≥ria, mas quando uma classe herda outra, essa rela√ß√£o precisa ser vinculada.&lt;/p>
&lt;p>Sendo assim, a cada requisi√ß√£o, ele precisa vincular as depend√™ncias entre as classes em tempo de execu√ß√£o. Lembra do ponto em reaproveitar trabalho? Bom, se podemos reaproveitar, podemos ganhar performance!&lt;/p>
&lt;p>Para implementar esse preloading, alguns frameworks j√° trazem alguma solu√ß√£o pronta, como por exemplo o &lt;a href="https://symfony.com/blog/new-in-symfony-4-4-preloading-symfony-applications-in-php-7-4">Symfony&lt;/a>.&lt;/p>
&lt;p>Mas nada que n√£o possa ser feito em outro framework. Basicamente √© apontar um arquivo de preload no seu &lt;code>php.ini&lt;/code> dentro das configura√ß√µes do OPcache.&lt;/p>
&lt;pre>&lt;code>opcache.preload=/path/to/project/preload.php
&lt;/code>&lt;/pre>&lt;p>E dentro deste arquivo, carregar todo o seu projeto.&lt;/p>
&lt;pre>&lt;code>$files = require 'vendor/composer/autoload_classmap.php';
foreach (array_unique($files) as $file) {
opcache_compile_file($file);
}
&lt;/code>&lt;/pre>&lt;p>Bom, neste exemplo ir√≠amos carregar o projeto todo. Para iniciar n√£o √© ruim, mas tendo em mente que √© preciso melhorar.&lt;/p>
&lt;p>Nosso projeto n√£o utiliza TODOS os arquivos e TODAS classes que temos, ent√£o qual motivo de carregar tudo?&lt;/p>
&lt;p>Aqui tem uma thread para se adicionar o preloading no composer de forma nativa, &lt;a href="https://github.com/composer/composer/issues/7777#issuecomment-440268416">mas tem um coment√°rio&lt;/a> bem bacana sobre os ganhos de fazer um preloading apenas das classes mais utilizadas no projeto.&lt;/p>
&lt;p>&lt;img src="images/6.png" alt="10.1.png">&lt;/p>
&lt;p>Com isso, da para ter uma ideia do custo/benef√≠cio de cada abordagem. Eu recomendo o preloading apenas das classes principais. Mas, voc√™ pode come√ßar fazendo do projeto todo para ter um ganho inicial.&lt;/p>
&lt;p>At√© o momento, ainda n√£o utilizei &lt;a href="https://github.com/DarkGhostHunter/Preloader">esta lib&lt;/a>, mas achei bem interessante a ideia e pretendo utilizar. Quando fizer, coloco aqui os resultados.&lt;/p>
&lt;p>&lt;a href="https://stitcher.io/blog/preloading-in-php-74">Aqui tem um artigo&lt;/a> bacana sobre esse assunto, onde voc√™ pode se aprofundar um pouco mais.&lt;/p>
&lt;p>&lt;strong>B√¥nus:&lt;/strong> como falamos sobre o composer, n√£o vou abrir uma sess√£o exclusiva pra isso, acho que podemos resumir rapidamente o que precisa ser feito para otimiz√°-lo. Na &lt;a href="https://getcomposer.org/doc/articles/autoloader-optimization.md">documenta√ß√£o oficial&lt;/a> tem os detalhes, ent√£o para instalar seu projeto em produ√ß√£o utilize estas instru√ß√µes:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">/usr/bin/composer install --no-dev -o -a
&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h2 id="11-generators">11. Generators&lt;/h2>
&lt;p>Essa tamb√©m √© uma ferramenta bem poderosa que temos, n√£o apenas no PHP, mas em todo o ecossistema de desenvolvimento. Na &lt;a href="https://www.php.net/manual/en/language.generators.overview.php">documenta√ß√£o oficial&lt;/a>, temos um detalhamento melhor sobre isso, mas podemos resumir em dois itens:&lt;/p>
&lt;ul>
&lt;li>√â uma forma simples de escrever &lt;a href="https://www.php.net/manual/en/language.oop5.iterations.php">iterators&lt;/a>&lt;/li>
&lt;li>√â poss√≠vel iterar dados sem precisar construir um array em mem√≥ria&lt;/li>
&lt;/ul>
&lt;p>Com isso em mente, e ainda analisando a documenta√ß√£o oficial, temos um exemplo de implementa√ß√£o de um &lt;code>range()&lt;/code> que vou fazer uma altera√ß√£o para ilustrar melhor a ideia:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#75715e">// range nativo
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">foreach&lt;/span> (&lt;span style="color:#a6e22e">range&lt;/span>(&lt;span style="color:#ae81ff">1&lt;/span>, &lt;span style="color:#ae81ff">1_000_000&lt;/span>) &lt;span style="color:#66d9ef">as&lt;/span> $number) {
&lt;span style="color:#66d9ef">echo&lt;/span> $number &lt;span style="color:#f92672">.&lt;/span> &lt;span style="color:#a6e22e">PHP_EOL&lt;/span>;
}
&lt;span style="color:#75715e">// range com generator
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">xrange&lt;/span>(&lt;span style="color:#a6e22e">int&lt;/span> $start, &lt;span style="color:#a6e22e">int&lt;/span> $end) {
&lt;span style="color:#66d9ef">for&lt;/span> ($i &lt;span style="color:#f92672">=&lt;/span> $start; $i &lt;span style="color:#f92672">&amp;lt;=&lt;/span> $end; $i&lt;span style="color:#f92672">++&lt;/span>) {
&lt;span style="color:#66d9ef">yield&lt;/span> $i;
}
}
&lt;span style="color:#66d9ef">foreach&lt;/span> (&lt;span style="color:#a6e22e">xrange&lt;/span>(&lt;span style="color:#ae81ff">1&lt;/span>, &lt;span style="color:#ae81ff">1_000_000&lt;/span>) &lt;span style="color:#66d9ef">as&lt;/span> $number) {
&lt;span style="color:#66d9ef">echo&lt;/span> $number &lt;span style="color:#f92672">.&lt;/span> &lt;span style="color:#a6e22e">PHP_EOL&lt;/span>;
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Se voc√™ tentar rodar esse c√≥digo, pode ser que voc√™ receba um: &lt;code>Fatal error: Allowed memory size&lt;/code> (dependendo da sua configura√ß√£o no &lt;code>php.ini&lt;/code>).&lt;/p>
&lt;p>Na implementa√ß√£o nativa do &lt;code>range&lt;/code>, por ele tentar alocar em mem√≥ria 1M de integers, voc√™ pode explodir seu script por falta de mem√≥ria. O que no &lt;code>xrange&lt;/code> n√£o ocorre, pois ele alocou apenas 1. Sim, isso mesmo, apenas 1.&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Que diferen√ßa hein?!&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>Isso ocorre pois o retorno vai &amp;ldquo;passo a passo&amp;rdquo;, retornando um generator para que o &lt;code>foreach&lt;/code> o execute um a um. √â uma pr√°tica bem comum utilizar essa t√©cnica ao ler arquivos bem grandes.&lt;/p>
&lt;p>Bom, acho que ja √© poss√≠vel entender os ganhos at√© aqui de se utilizar essa t√©cnica. Foi pensando nisso que o Laravel implementou as &lt;a href="https://laravel.com/docs/master/collections#lazy-collections">LazyCollections&lt;/a>, por exemplo.&lt;/p>
&lt;blockquote>
&lt;p>Mas os generators v√£o al√©m disso. E √© aqui que tudo come√ßa a ficar bem mais interessante! Os generators abrem as portas para se trabalhar com corrotinas utilizando PHP. Sim, muito maneiro! E isso j√° existe desde a vers√£o 5.5.&lt;/p>
&lt;/blockquote>
&lt;p>Aqui o assunto come√ßa a ficar mais complexo, e tudo bem, n√£o √© f√°cil entender tudo isso logo de cara&amp;hellip; √â uma forma diferente de manipular e interagir com o estado de uma aplica√ß√£o, ent√£o, antes de avan√ßar, recomendo que voc√™ entenda melhor este e outros termos que vamos come√ßar a utilizar daqui pra frente, e como tudo isso se relaciona.&lt;/p>
&lt;p>Para isso, vou deixar um roteiro de artigos aqui para voc√™:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.treinaweb.com.br/blog/concorrencia-paralelismo-processos-threads-programacao-sincrona-e-assincrona/">Introdu√ß√£o te√≥rica a estes termos&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://thephp.website/br/edicao/voce-achou-que-sabia-sobre-generators/">Entendendo mais sobre generators&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://nikic.github.io/2012/12/22/Cooperative-multitasking-using-coroutines-in-PHP.html">Corrotinas com generators&lt;/a>&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="12-c√≥digo-ass√≠ncrono">12. C√≥digo ass√≠ncrono&lt;/h2>
&lt;p>Bom, a partir daqui, podemos assumir que voc√™ j√° entende a teoria sobre processos ass√≠ncronos. Ent√£o, nada melhor do que come√ßar a colocar isso em pr√°tica!&lt;/p>
&lt;p>Existem muitas formas de come√ßar, mas quero usar uma abordagem pensando em como melhorar algum servi√ßo que voc√™ j√° tenha funcionando em produ√ß√£o, sem precisar mudar framework ou uma grande quantidade de c√≥digo.&lt;/p>
&lt;blockquote>
&lt;p>Antes de iniciar de fato no c√≥digo ass√≠ncrono, queria apenas pontuar a diferen√ßa de se utilizar jobs ass√≠ncronos. N√£o quero entrar muito no detalhe, vou deixar a &lt;a href="https://laravel.com/docs/master/queues">documenta√ß√£o do Laravel&lt;/a> sobre isso, tem bastante conte√∫do l√°. Tamb√©m √© algo extremamente recomendado ao se pensar em performance, ent√£o caso voc√™ n√£o conhe√ßa, comece a utilizar!&lt;/p>
&lt;/blockquote>
&lt;p>Para colocar a m√£o na massa, queria introduzir a utiliza√ß√£o &lt;a href="https://github.com/spatie/async">desta biblioteca&lt;/a>, j√° utilizei e gostei bastante. Ela resolve um problema cl√°ssico onde voc√™ precisa buscar dados em diferentes lugares mas eles n√£o s√£o dependentes, ou seja, √© poss√≠vel busca-los ao mesmo tempo e reduzir o tempo de resposta da aplica√ß√£o.&lt;/p>
&lt;p>A documenta√ß√£o √© bem bacana, tem diversos exemplos e √© bem simples de se utilizar. Com pouco c√≥digo, j√° √© poss√≠vel conseguir bons resultados, e o melhor, sem precisar alterar todo seu sistema.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#66d9ef">use&lt;/span> &lt;span style="color:#a6e22e">Spatie\Async\Pool&lt;/span>;
$pool &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">Pool&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#a6e22e">create&lt;/span>();
&lt;span style="color:#66d9ef">foreach&lt;/span> ($things &lt;span style="color:#66d9ef">as&lt;/span> $thing) {
$pool&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">add&lt;/span>(&lt;span style="color:#66d9ef">function&lt;/span> () &lt;span style="color:#66d9ef">use&lt;/span> ($thing) {
&lt;span style="color:#75715e">// Do a thing
&lt;/span>&lt;span style="color:#75715e">&lt;/span> })&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">then&lt;/span>(&lt;span style="color:#66d9ef">function&lt;/span> ($output) {
&lt;span style="color:#75715e">// Handle success
&lt;/span>&lt;span style="color:#75715e">&lt;/span> })&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">catch&lt;/span>(&lt;span style="color:#66d9ef">function&lt;/span> (&lt;span style="color:#a6e22e">Throwable&lt;/span> $exception) {
&lt;span style="color:#75715e">// Handle exception
&lt;/span>&lt;span style="color:#75715e">&lt;/span> });
}
$pool&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">wait&lt;/span>();
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Claro, isso √© uma abordagem bem inicial. &lt;a href="https://stitcher.io/blog/asynchronous-php">Aqui tem uma publica√ß√£o&lt;/a> que fala um pouco dessa primeira abordagem e o problema que ela quer resolver. Criar sistemas √© assim, saber utilizar a ferramenta correta para resolver um problema espec√≠fico, e mesmo assim as possibilidades s√£o amplas. Ent√£o saiba escolher o que utilizar e quando utilizar!&lt;/p>
&lt;hr>
&lt;h2 id="13-non-blocking-io-com-php">13. Non-blocking I/O com PHP&lt;/h2>
&lt;p>Pode falar, t√≠tulo maneiro n√©? E sim, muitos programadores realmente duvidam que isso existe no PHP, al√©m de existir √© muito poderoso!&lt;/p>
&lt;p>As primeiras solu√ß√µes encontradas ao se iniciar nesse assunto no PHP √© o &lt;a href="https://amphp.org/">Apm&lt;/a> e o &lt;a href="https://reactphp.org/">ReactPHP&lt;/a>. Sim, vamos falar sobre eles aqui, mas calma, tem mais!&lt;/p>
&lt;p>Basicamente essas implementa√ß√µes seguem a &lt;a href="https://en.wikipedia.org/wiki/Reactor_pattern">Reactor Design Pattern&lt;/a>, implementando uma arquitetura orientada a eventos, realizando opera√ß√µes I/O de forma n√£o bloqueante, utilizando um &lt;a href="https://reactphp.org/event-loop/">event loop&lt;/a> como core.&lt;/p>
&lt;p>Com esse event loop, um mar de possibilidades √© aberto, podemos implementar servidor http, por exemplo, onde a utiliza√ß√£o do Nginx se torna opcional, e n√£o mais obrigat√≥ria para rodar seu c√≥digo.&lt;/p>
&lt;p>Para iniciar um Hello World no ReactPHP √© bem simples, na &lt;a href="https://reactphp.org/">p√°gina inicial da documenta√ß√£o&lt;/a> j√° tem um exemplo bacana. Caso voc√™ queira come√ßar a explorar mais sobre ele, a documenta√ß√£o tem bastante conte√∫do.&lt;/p>
&lt;p>&lt;img src="images/7.jpeg" alt="Hello World com ReactPHP">&lt;/p>
&lt;p>Mas estamos aqui para falar de um framework que entrega o maior n√≠vel de performance para aplica√ß√µes PHP: o &lt;a href="https://www.swoole.co.uk/">Swoole&lt;/a>. Sou um pouco suspeito para falar sobre este assunto, pois quando conheci foi amor a primeira vista. Ele √© realmente incr√≠vel. Os citados acima tamb√©m s√£o interessantes, acho que vale a pena conhecer, mas se for para escolher, com certeza vou de Swoole!&lt;/p>
&lt;p>&lt;img src="images/8.png" alt="13.2.png">&lt;/p>
&lt;blockquote>
&lt;p>Funcionamento do PHP-FPM + Nginx vs. Swoole&lt;/p>
&lt;/blockquote>
&lt;p>Uma das coisas que achei sensacional foi o suporte nativo de m√∫ltiplos cores de CPU e &lt;a href="https://www.swoole.co.uk/docs/modules/swoole-multiprocessing">multiprocessamento&lt;/a> (&lt;a href="https://pt.wikipedia.org/wiki/Multiprocessamento">?&lt;/a>), dando mais poder para o Swoole.&lt;/p>
&lt;p>Tamb√©m √© poss√≠vel &lt;a href="https://www.swoole.co.uk/docs/modules/swoole-process-pool">gerenciar um conjunto de processos&lt;/a> de forma muito f√°cil. Vamos pensar em um caso de uso real. Voc√™ vai realizar diversas opera√ß√µes em um Redis, para isso voc√™ precisa de uma conex√£o. Para extrair o m√°ximo de performance, √© recomendado realizar um pool de conex√µes e reutiliza-las. Como fazer isso ent√£o?&lt;/p>
&lt;p>Primeiro, precisamos iniciar estas conex√µes. Faremos isso quando um worker do Swoole for iniciado &lt;code>(WorkerStart)&lt;/code>, assim n√£o prejudicamos o tempo das requisi√ß√µes que v√£o chegar, pois faremos isso antes do worker estar pronto. Iremos utilizar o &lt;a href="https://www.swoole.co.uk/docs/modules/swoole-coroutine-channel">Swoole Coroutine Channel&lt;/a> para compartilhar as conex√µes abertas entre as requisi√ß√µes.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#a6e22e">php&lt;/span>
&lt;span style="color:#66d9ef">use&lt;/span> &lt;span style="color:#a6e22e">Swoole\Http\Server&lt;/span>;
&lt;span style="color:#66d9ef">use&lt;/span> &lt;span style="color:#a6e22e">Swoole\Coroutine\Channel&lt;/span>;
&lt;span style="color:#66d9ef">use&lt;/span> &lt;span style="color:#a6e22e">Swoole\Coroutine\Redis&lt;/span>;
$server &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Server&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;0.0.0.0&amp;#39;&lt;/span>, &lt;span style="color:#ae81ff">8000&lt;/span>);
$chan &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Channel&lt;/span>(&lt;span style="color:#ae81ff">100&lt;/span>);
$server&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">on&lt;/span>(
&lt;span style="color:#e6db74">&amp;#39;WorkerStart&amp;#39;&lt;/span>,
&lt;span style="color:#66d9ef">function&lt;/span> (&lt;span style="color:#a6e22e">Server&lt;/span> $server) &lt;span style="color:#66d9ef">use&lt;/span> ($chan) {
&lt;span style="color:#66d9ef">for&lt;/span> ($i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; $i &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">100&lt;/span>; $i&lt;span style="color:#f92672">++&lt;/span>) {
$redis &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Redis&lt;/span>();
$redis&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">connect&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;127.0.0.1&amp;#39;&lt;/span>, &lt;span style="color:#ae81ff">6379&lt;/span>);
$chan&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">push&lt;/span>($redis);
}
}
);
$server&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">on&lt;/span>(
&lt;span style="color:#e6db74">&amp;#39;request&amp;#39;&lt;/span>,
&lt;span style="color:#66d9ef">function&lt;/span> ($request, $response) &lt;span style="color:#66d9ef">use&lt;/span> ($chan) {
&lt;span style="color:#e6db74">/** @var Redis $redis */&lt;/span>
$redis &lt;span style="color:#f92672">=&lt;/span> $chan&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">pop&lt;/span>();
$redis&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">set&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;swoole&amp;#39;&lt;/span>, &lt;span style="color:#a6e22e">rand&lt;/span>(&lt;span style="color:#ae81ff">1&lt;/span>, &lt;span style="color:#ae81ff">100&lt;/span>));
$result &lt;span style="color:#f92672">=&lt;/span> $redis&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">get&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;swoole&amp;#39;&lt;/span>);
$response&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">end&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;&amp;lt;h1&amp;gt;Hello World. #&lt;/span>&lt;span style="color:#e6db74">{&lt;/span>$result&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;lt;/h1&amp;gt;&amp;#34;&lt;/span>);
&lt;span style="color:#75715e">// return connection to the channel
&lt;/span>&lt;span style="color:#75715e">&lt;/span> $chan&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">push&lt;/span>($redis);
}
);
$server&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>();
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Neste exemplo acima, podemos ainda implementar um &lt;a href="https://www.swoole.co.uk/docs/modules/swoole-timer">Timer&lt;/a>, que de tempos em tempos valida se todas as conex√µes est√£o ativas, caso n√£o esteja, ele renova automaticamente sem afetar uma requisi√ß√£o. Dando mais poder para nossa aplica√ß√£o.&lt;/p>
&lt;p>Tudo isso se baseando nas &lt;a href="https://www.swoole.co.uk/docs/modules/swoole-coroutine">Swoole Coroutines&lt;/a>, onde ao escrever um c√≥digo no &amp;ldquo;estilo s√≠ncrono&amp;rdquo;, temos todo o poder do async I/O non-blocking proporcionado pelo Swoole, sem precisar ficar escrevendo callbacks e awaits pelo c√≥digo.&lt;/p>
&lt;p>O Swoole muda bastante o comportamento do PHP, por exemplo ao reutilizar tudo que foi alocado em mem√≥ria entre as requisi√ß√µes, antes de utilizar em produ√ß√£o, leia &lt;strong>MUITO&lt;/strong> sobre essa e outras mudan√ßas de comportamento para n√£o enfrentar problemas.&lt;/p>
&lt;p>√â poss√≠vel rodar aplica√ß√µes &lt;a href="https://github.com/swooletw/laravel-swoole">Laravel&lt;/a> e &lt;a href="https://www.swoole.co.uk/article/symfony-swoole">Symfony&lt;/a> em cima do Swoole de forma f√°cil. √â bom para come√ßar a entender como ele funciona, mas para atingir a m√°xima performance, n√£o √© o recomendado. Para isso, temos frameworks pr√≥prios, por exemplo o &lt;a href="https://www.easyswoole.com/En/Preface/introduction.html">easySwoole&lt;/a> e o &lt;a href="https://hyperf.wiki/2.1/#/en/">Hyperf&lt;/a>.&lt;/p>
&lt;p>Na documenta√ß√£o oficial, existe uma &lt;a href="https://www.swoole.co.uk/articles">se√ß√£o de artigos&lt;/a> explicando algumas implementa√ß√µes e uma &lt;a href="https://www.swoole.co.uk/docs/common-questions-index">FAQ&lt;/a>, caso queira se aprofundar mais tem coisa bem bacana por l√°.&lt;/p>
&lt;hr>
&lt;p>Bom, por enquanto vamos ficando por aqui. Com todas essas dicas, acredito que suas aplica√ß√µes v√£o realmente atingir resultados incr√≠veis usando PHP.&lt;/p>
&lt;p>Depois me conta se essas dicas fizeram efeito nos seus projetos e o quanto isso te ajudou! (:&lt;/p></content></item></channel></rss>